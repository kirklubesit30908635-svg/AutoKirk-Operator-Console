      - name: Call Supabase RPC run_billing_ops_cycle
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -e

          echo "Running Billing Ops Cycle..."

          resp=$(curl -sS -X POST "$SUPABASE_URL/rest/v1/rpc/run_billing_ops_cycle" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -d '{}')

          echo "$resp"

          if echo "$resp" | grep -qi "error"; then
            echo "Supabase returned an error â€” failing workflow."
            exit 1
          fi

          echo "Billing Ops Cycle completed successfully."
